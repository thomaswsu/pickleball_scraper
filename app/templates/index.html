<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SF Pickleball Availability</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <main class="mx-auto flex max-w-6xl flex-col gap-8 p-4 md:p-8">
      <header class="space-y-2">
        <h1 class="text-3xl font-semibold">SF Rec &amp; Park Court Watcher</h1>
        <p class="text-slate-600">
          Monitor live availability from rec.us and set up instant alerts for the slots you care
          about. Designed for quick use on your phone or desktop.
        </p>
        <div class="flex flex-wrap items-center gap-3 text-sm text-slate-500" id="status-badges">
          <span id="status-last-sync">Last sync: --</span>
          <span id="status-error" class="hidden rounded bg-rose-100 px-2 py-1 text-rose-600"></span>
          <button
            id="refresh-btn"
            class="rounded-full bg-blue-600 px-4 py-1 text-white shadow-sm transition hover:bg-blue-500 active:scale-95"
            type="button"
          >
            Refresh now
          </button>
        </div>
      </header>

      <section class="space-y-4">
        <div class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
          <div>
            <h2 class="text-2xl font-semibold">Current Availability</h2>
            <span class="text-sm text-slate-500" id="location-count"></span>
          </div>
        <div class="flex flex-wrap items-end gap-3 text-sm text-slate-600">
            <label class="block">
              Date
              <input
                id="filter-date"
                type="date"
                class="mt-1 rounded-lg border border-slate-200 p-2 focus:border-blue-500 focus:outline-none"
              />
            </label>
            <label class="block">
              Time from
              <input
                id="filter-time-from"
                type="time"
                class="mt-1 rounded-lg border border-slate-200 p-2 focus:border-blue-500 focus:outline-none"
              />
            </label>
            <label class="block">
              Time to
              <input
                id="filter-time-to"
                type="time"
                class="mt-1 rounded-lg border border-slate-200 p-2 focus:border-blue-500 focus:outline-none"
              />
            </label>
            <button
              id="filter-reset"
              type="button"
              class="rounded-lg border border-slate-200 px-3 py-2 text-xs text-slate-600 hover:bg-slate-100"
            >
              Clear
            </button>
          </div>
        </div>
        <div id="locations-grid" class="space-y-4"></div>
      </section>

      <section class="grid gap-6 md:grid-cols-2">
        <div class="rounded-2xl bg-white p-4 shadow-sm">
          <h3 class="text-xl font-semibold">Create an alert</h3>
          <form id="watch-form" class="mt-3 space-y-3">
            <label class="block text-sm font-medium text-slate-600">
              Location
              <select
                id="watch-location"
                class="mt-1 w-full rounded-lg border border-slate-200 p-2 focus:border-blue-500 focus:outline-none"
                required
              >
              </select>
            </label>
            <label class="block text-sm font-medium text-slate-600">
              Court filter (optional)
              <input
                id="watch-court"
                type="text"
                placeholder="e.g., Court 1 or Lights"
                class="mt-1 w-full rounded-lg border border-slate-200 p-2 focus:border-blue-500 focus:outline-none"
              />
            </label>
            <label class="block text-sm font-medium text-slate-600">
              Target date (optional)
              <input
                id="watch-date"
                type="date"
                class="mt-1 w-full rounded-lg border border-slate-200 p-2 focus:border-blue-500 focus:outline-none"
              />
            </label>
            <div class="grid grid-cols-2 gap-3">
              <label class="block text-sm font-medium text-slate-600">
                Time from
                <input
                  id="watch-time-from"
                  type="time"
                  class="mt-1 w-full rounded-lg border border-slate-200 p-2 focus:border-blue-500 focus:outline-none"
                />
              </label>
              <label class="block text-sm font-medium text-slate-600">
                Time to
                <input
                  id="watch-time-to"
                  type="time"
                  class="mt-1 w-full rounded-lg border border-slate-200 p-2 focus:border-blue-500 focus:outline-none"
                />
              </label>
            </div>
            <label class="block text-sm font-medium text-slate-600">
              Alert label
              <input
                id="watch-label"
                type="text"
                placeholder="ex: Tuesday Doubles 9am"
                class="mt-1 w-full rounded-lg border border-slate-200 p-2 focus:border-blue-500 focus:outline-none"
              />
            </label>
            <label class="block text-sm font-medium text-slate-600">
              Email address
              <input
                id="watch-email"
                type="email"
                placeholder="you@example.com"
                class="mt-1 w-full rounded-lg border border-slate-200 p-2 focus:border-blue-500 focus:outline-none"
              />
            </label>
            <label class="block text-sm font-medium text-slate-600">
              Notes
              <textarea
                id="watch-notes"
                rows="2"
                class="mt-1 w-full rounded-lg border border-slate-200 p-2 focus:border-blue-500 focus:outline-none"
              ></textarea>
            </label>
            <button
              type="submit"
              class="w-full rounded-xl bg-emerald-600 py-2 text-white shadow-sm transition hover:bg-emerald-500 active:scale-95"
            >
              Save alert
            </button>
            <p id="watch-form-message" class="text-sm text-emerald-600"></p>
          </form>
        </div>

        <div class="rounded-2xl bg-white p-4 shadow-sm">
          <div class="flex items-center justify-between">
            <h3 class="text-xl font-semibold">Alerts &amp; history</h3>
            <button
              id="alerts-refresh"
              class="text-sm text-blue-600 hover:underline"
              type="button"
            >
              Refresh
            </button>
          </div>
          <div id="alerts-list" class="mt-4 space-y-2 text-sm text-slate-700"></div>
        </div>
      </section>

      <section class="rounded-2xl bg-white p-4 shadow-sm">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-semibold">Active watches</h3>
          <button id="watchers-refresh" class="text-sm text-blue-600 hover:underline" type="button">
            Refresh
          </button>
        </div>
        <div id="watchers-list" class="mt-4 space-y-3"></div>
      </section>
    </main>

    <script>
      const statusLastSync = document.getElementById("status-last-sync");
      const statusError = document.getElementById("status-error");
      const refreshBtn = document.getElementById("refresh-btn");
      const locationCount = document.getElementById("location-count");
      const locationsGrid = document.getElementById("locations-grid");
      const watchForm = document.getElementById("watch-form");
      const watchLocationSelect = document.getElementById("watch-location");
      const watchFormMessage = document.getElementById("watch-form-message");
      const watchEmailInput = document.getElementById("watch-email");
      const alertsList = document.getElementById("alerts-list");
      const watchersList = document.getElementById("watchers-list");
      const filterDate = document.getElementById("filter-date");
      const filterTimeFrom = document.getElementById("filter-time-from");
      const filterTimeTo = document.getElementById("filter-time-to");
      const filterReset = document.getElementById("filter-reset");

      const fmtDateTime = new Intl.DateTimeFormat(undefined, {
        weekday: "short",
        month: "short",
        day: "numeric",
        hour: "numeric",
        minute: "2-digit",
      });

      const fmtTime = new Intl.DateTimeFormat(undefined, {
        hour: "numeric",
        minute: "2-digit",
      });

      async function fetchJSON(url, options = {}) {
        const response = await fetch(url, options);
        if (!response.ok) {
          const text = await response.text();
          throw new Error(text || "Request failed");
        }
        return response.json();
      }

      function renderSlots(slots) {
        if (!slots.length) {
          return '<p class="text-sm text-slate-500">No open slots right now.</p>';
        }
        return `
          <div class="grid gap-2 sm:grid-cols-2">
            ${slots
              .slice(0, 12)
              .map((slot) => {
                const localTime = fmtDateTime.format(new Date(slot.slot_time_local));
                return `
                  <div class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm">
                    <div class="font-medium text-slate-900">${localTime}</div>
                    <div class="text-slate-500">
                      ${slot.court_name ? slot.court_name : slot.court_id}
                      ${slot.duration_minutes ? " Â· " + slot.duration_minutes + " min" : ""}
                    </div>
                  </div>
                `;
              })
              .join("")}
          </div>
        `;
      }

      function getMinutesFromInput(value) {
        if (!value) return null;
        const [hours, mins] = value.split(":").map(Number);
        return hours * 60 + mins;
      }

      function slotPassesFilters(slot) {
        const slotDate = new Date(slot.slot_time_local);
        if (filterDate.value) {
          const iso = slotDate.toISOString().slice(0, 10);
          if (iso !== filterDate.value) {
            return false;
          }
        }
        const fromMinutes = getMinutesFromInput(filterTimeFrom.value);
        const toMinutes = getMinutesFromInput(filterTimeTo.value);
        if (fromMinutes === null && toMinutes === null) return true;
        const totalMinutes = slotDate.getHours() * 60 + slotDate.getMinutes();
        if (fromMinutes !== null && totalMinutes < fromMinutes) {
          return false;
        }
        if (toMinutes !== null && totalMinutes > toMinutes) {
          return false;
        }
        return true;
      }

      let locationsCache = [];

      async function loadLocations() {
        const data = await fetchJSON("/api/locations");
        if (data.last_updated) {
          statusLastSync.textContent = `Last sync: ${fmtDateTime.format(new Date(data.last_updated))}`;
        } else {
          statusLastSync.textContent = "Last sync: pending...";
        }

        locationCount.textContent = `${data.locations.length} locations`;
        locationsCache = data.locations;
        renderLocations();
      }

      function renderLocations() {
        const filtered = locationsCache.map(loc => ({
          ...loc,
          slots: loc.slots.filter(slotPassesFilters),
        }));

        locationsGrid.innerHTML = filtered
          .map(
            (loc) => `
              <article class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
                <div class="flex items-start gap-3">
                  ${
                    loc.image_url
                      ? `<img src="${loc.image_url}" class="hidden h-16 w-24 rounded-lg object-cover sm:block" alt="${loc.name}" />`
                      : ""
                  }
                  <div>
                    <h3 class="text-lg font-semibold">${loc.name}</h3>
                    <p class="text-sm text-slate-500">${loc.address ? loc.address : "Address unavailable"}</p>
                    ${formatDurations(loc.slots)}
                  </div>
                </div>
                <div class="mt-3">${renderSlots(loc.slots)}</div>
              </article>
            `
          )
          .join("");

        const optionsHtml = locationsCache
          .map((loc) => `<option value="${loc.location_id ? loc.location_id : loc.id}">${loc.name}</option>`)
          .join("");
        watchLocationSelect.innerHTML = optionsHtml;
      }

      async function loadStatus() {
        const status = await fetchJSON("/api/status");
        if (status.last_error) {
          statusError.textContent = status.last_error;
          statusError.classList.remove("hidden");
        } else {
          statusError.classList.add("hidden");
        }
      }

      function renderWatch(watch) {
        return `
          <div class="rounded-xl border border-slate-200 p-4">
            <div class="flex items-center justify-between gap-3">
              <div>
                <p class="text-sm font-semibold">${watch.label ? watch.label : watch.location_name}</p>
                <p class="text-xs text-slate-500">${watch.location_name}</p>
              </div>
              <span class="text-xs font-medium ${
                watch.active ? "text-emerald-600" : "text-slate-400"
              }">${watch.active ? "ACTIVE" : "PAUSED"}</span>
            </div>
            <ul class="mt-2 text-xs text-slate-600 space-y-1">
              ${
                watch.court_query
                  ? `<li>Court filter: <strong>${watch.court_query}</strong></li>`
                  : ""
              }
              ${
                watch.target_date
                  ? `<li>Date: ${new Date(watch.target_date).toLocaleDateString()}</li>`
                  : ""
              }
              ${
                watch.time_from
                  ? `<li>Time window: ${fmtTime.format(
                      new Date('1970-01-01T' + watch.time_from)
                    )} - ${watch.time_to ? fmtTime.format(new Date('1970-01-01T' + watch.time_to)) : "end"}</li>`
                  : ""
              }
              ${watch.contact ? `<li>Email: ${watch.contact}</li>` : ""}
              ${watch.notes ? `<li>Notes: ${watch.notes}</li>` : ""}
            </ul>
            <div class="mt-3 flex gap-2 text-xs">
              <button data-action="toggle" data-id="${watch.id}" class="rounded-lg border border-slate-200 px-3 py-1">
                ${watch.active ? "Pause" : "Enable"}
              </button>
              <button data-action="delete" data-id="${watch.id}" class="rounded-lg border border-rose-200 px-3 py-1 text-rose-600">
                Delete
              </button>
            </div>
          </div>
        `;
      }

      async function loadWatchers() {
        const watchers = await fetchJSON("/api/watchers");
        if (!watchers.length) {
          watchersList.innerHTML = '<p class="text-sm text-slate-500">No alerts yet.</p>';
          return;
        }
        watchersList.innerHTML = watchers.map((w) => renderWatch(w)).join("");
      }

      async function loadAlerts() {
        const alerts = await fetchJSON("/api/alerts?limit=15");
        if (!alerts.length) {
          alertsList.innerHTML = '<p class="text-sm text-slate-500">No alerts fired yet.</p>';
          return;
        }
        alertsList.innerHTML = alerts
          .map((alert) => {
            const time = fmtDateTime.format(new Date(alert.slot_time_local));
            return `
              <div class="rounded-xl border border-slate-200 p-3">
                <div class="text-sm font-semibold">${alert.watch_label ? alert.watch_label : "Alert"}</div>
                <div class="text-xs text-slate-500">${time} &middot; ${alert.court_name ? alert.court_name : alert.court_id}</div>
              </div>
            `;
          })
          .join("");
      }

      watchForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const payload = {
          location_id: watchLocationSelect.value,
          court_query: document.getElementById("watch-court").value || null,
          target_date: document.getElementById("watch-date").value || null,
          time_from: document.getElementById("watch-time-from").value || null,
          time_to: document.getElementById("watch-time-to").value || null,
          label: document.getElementById("watch-label").value || null,
           contact: watchEmailInput.value || null,
          notes: document.getElementById("watch-notes").value || null,
        };
        try {
          await fetchJSON("/api/watchers", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          watchFormMessage.textContent = "Alert saved!";
          watchFormMessage.classList.remove("text-rose-600");
          watchFormMessage.classList.add("text-emerald-600");
          watchForm.reset();
          await loadWatchers();
        } catch (error) {
          watchFormMessage.textContent = error.message ? error.message : "Could not save alert.";
          watchFormMessage.classList.add("text-rose-600");
          watchFormMessage.classList.remove("text-emerald-600");
        }
      });

      watchersList.addEventListener("click", async (event) => {
        const btn = event.target.closest("button[data-action]");
        if (!btn) return;
        const id = btn.dataset.id;
        const action = btn.dataset.action;
        if (action === "delete") {
          await fetchJSON(`/api/watchers/${id}`, { method: "DELETE" });
        } else if (action === "toggle") {
          await fetchJSON(`/api/watchers/${id}/toggle`, { method: "POST" });
        }
        await loadWatchers();
      });

      document.getElementById("alerts-refresh").addEventListener("click", loadAlerts);
      document.getElementById("watchers-refresh").addEventListener("click", loadWatchers);
      [filterDate, filterTimeFrom, filterTimeTo].forEach(input =>
        input.addEventListener("change", () => {
          renderLocations();
        }),
      );
      filterReset.addEventListener("click", () => {
        filterDate.value = "";
        filterTimeFrom.value = "";
        filterTimeTo.value = "";
        renderLocations();
      });
      refreshBtn.addEventListener("click", () => {
        loadLocations();
        loadStatus();
      });

      async function bootstrap() {
        await Promise.all([loadLocations(), loadStatus(), loadWatchers(), loadAlerts()]);
      }

      bootstrap();
      setInterval(loadLocations, 60000);
      setInterval(loadAlerts, 60000);
    </script>
  </body>
</html>
      function formatDurations(slots) {
        const durations = [...new Set(slots.map(slot => slot.duration_minutes).filter(Boolean))].sort(
          (a, b) => a - b,
        );
        if (!durations.length) return "";
        return `<p class="text-xs text-slate-500 mt-1">Durations: ${durations.join(" / ")} min</p>`;
      }
